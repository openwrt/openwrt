From cc8b15d613809be33ea6fe4aa618bb1a6e187d1a Mon Sep 17 00:00:00 2001
From: Javier Marcet <javier@marcet.info>
Date: Sat, 4 Oct 2025 18:05:20 +0200
Subject: [PATCH] ptgen: drop hybrid bios boot partition for guid dual boot

Signed-off-by: Javier Marcet <javier@marcet.info>
---
 src/ptgen.c | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/src/ptgen.c b/src/ptgen.c
index d480908..97a2c4e 100644
--- a/src/ptgen.c
+++ b/src/ptgen.c
@@ -66,6 +66,10 @@ typedef struct {
 	GUID_INIT( 0xEBD0A0A2, 0xB9E5, 0x4433, \
 			0x87, 0xC0, 0x68, 0xB6, 0xB7, 0x26, 0x99, 0xC7)
 
+#define GUID_PARTITION_FREEDESKTOP_BOOT \
+	GUID_INIT( 0xBC13C2FF, 0x59E6, 0x4262, \
+			0xA3, 0x52, 0xB2, 0x75, 0xFD, 0x6F, 0x71, 0x72)
+
 #define GUID_PARTITION_BIOS_BOOT \
 	GUID_INIT( 0x21686148, 0x6449, 0x6E6F, \
 			0x74, 0x4E, 0x65, 0x65, 0x64, 0x45, 0x46, 0x49)
@@ -489,7 +493,7 @@ static int gen_gptable(uint32_t signature, guid_t guid, unsigned nr)
 		printf("%" PRIu64 "\n", (sect - start) * DISK_SECTOR_SIZE);
 	}
 
-	if (parts[0].actual_start > GPT_FIRST_ENTRY_SECTOR + GPT_SIZE) {
+	if (use_guid_partition_table && parts[0].hybrid && parts[0].actual_start > GPT_FIRST_ENTRY_SECTOR + GPT_SIZE) {
 		gpte[GPT_ENTRY_MAX - 1].start = cpu_to_le64(gpt_first_entry_sector + GPT_SIZE);
 		gpte[GPT_ENTRY_MAX - 1].end = cpu_to_le64(parts[0].actual_start - 1);
 		gpte[GPT_ENTRY_MAX - 1].type = GUID_PARTITION_BIOS_BOOT;
@@ -636,6 +640,9 @@ static guid_t type_to_guid_and_name(unsigned char type, char **name)
 				*name = "EFI System Partition";
 			guid = GUID_PARTITION_SYSTEM;
 			break;
+		case 0xea:
+			guid = GUID_PARTITION_FREEDESKTOP_BOOT;
+			break;
 		case 0x83:
 			guid = GUID_PARTITION_LINUX_FS_GUID;
 			break;
-- 
2.34.1


#!/bin/sh /etc/rc.common
# Copyright (C) 2006 OpenWrt.org

START=11

apply_defaults() {
	local min_free mem="$(awk '/^MemTotal:/{print $2}' /proc/meminfo)"

	if [ "$mem" -gt 524288 ]; then # 1G
		min_free=65536
	elif [ "$mem" -gt 65536 ]; then # 128M
		min_free=16384
	elif [ "$mem" -gt 32768 ]; then # 64M
		min_free=8192
	else
		min_free=1024
	fi

	sysctl -qw vm.min_free_kbytes="$min_free"

	# first set default, then each interface to avoid race with appearing interfaces
	( cd /proc/sys/net/ipv6/conf && echo 0 | tee default/accept_ra */accept_ra ) 2>&1 >/dev/null
}

start() {
	apply_defaults
	for CONF in /etc/sysctl.d/*.conf /etc/sysctl.conf; do
		[ -f "$CONF" ] && sysctl -e -p "$CONF" >&-
	done
}

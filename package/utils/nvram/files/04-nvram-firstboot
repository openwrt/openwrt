#!/bin/sh

. /lib/functions/system.sh

[ "$(board_name)" = "asus,rt-ac3200" ] || exit 0

CHANGED=0

while IFS='=' read -r K V; do
	[ -n "$K" ] || continue
	case "$K" in \#*) continue ;; esac
	CUR="$(nvram get "$K" || true)"
	if [ -z "$CUR" ]; then
		nvram set "$K=$V"
		CHANGED=1
	fi
done <<'EOF'
2:sromrev=11
2:aga0=0x0
2:rawtempsense=0x1ff
2:aga1=0x0
2:aga2=0x0
2:papdcap5g=0
2:pdgain5g=4
2:rxgains5ghtrelnabypa0=1
2:rxgains5ghtrelnabypa1=1
2:rxgains5ghtrelnabypa2=1
1:temps_period=5
2:boardvendor=0x14e4
2:devpath2=sb/1/
1:devpath1=sb/1/
0:devpath0=sb/1/
2:mcsbw1605ghpo=0
1:boardrev=0x1421
0:boardvendor=0x14e4
1:rxchain=7
2:boardflags=0x30040000
1:gainctrlsph=0
2:antswitch=0
2:epagain5g=0
1:femctrl=3
0:venid=0x14e4
2:rxgains5ghelnagaina0=2
1:txchain=7
2:rxgains5ghelnagaina1=2
2:rxgains5ghelnagaina2=2
2:tempcorrx=0x3f
1:xtalfreq=40000
2:xtalfreq=40000
2:rxgains5gmtrisoa0=5
0:xtalfreq=40000
2:rxgains5gmtrisoa1=5
2:rxgains5gmtrisoa2=5
2:rxgains5gtrisoa2=5
2:boardflags2=0x00220102
2:rxgains5gtrisoa0=5
2:boardflags3=0x0
2:rxgains5gtrisoa1=5
0:dot11agduphrpo=0
2:rxgains5gelnagaina0=2
2:rxgains5gelnagaina1=2
2:rxgains5gelnagaina2=2
2:phycal_tempdelta=15
0:boardflags3=0x0
0:boardflags2=0x00220102
2:temps_hysteresis=5
0:tempoffset=255
2:mcslr5ghpo=0
0:subband5gver=0x4
2:tworangetssi5g=0
0:devid=0x43bc
2:mcsbw1605glpo=0
0:dot11agduplrpo=0
2:venid=0x14e4
2:rxgains5gtrelnabypa0=1
2:rxgains5gtrelnabypa1=1
2:rxgains5gtrelnabypa2=1
0:pdoffset40ma1=4369
0:pdoffset40ma2=4369
0:pdoffset40ma0=4369
2:femctrl=3
2:mcsbw1605gmpo=0
2:subband5gver=0x4
2:dot11agduphrpo=0
2:txchain=7
1:rawtempsense=0x1ff
1:tempoffset=255
2:devid=0x43bc
0:temps_period=5
2:tempsense_option=0x3
2:dot11agduplrpo=0
1:tempsense_option=0x3
2:rxgains5gmelnagaina0=2
2:rxgains5gmelnagaina1=2
2:rxgains5gmelnagaina2=2
2:rxchain=7
1:phycal_tempdelta=15
0:phycal_tempdelta=15
1:temps_hysteresis=5
1:boardvendor=0x14e4
2:temps_period=5
2:mcslr5glpo=0
2:tempsense_slope=0xff
2:gainctrlsph=0
0:sromrev=11
2:tempoffset=255
0:gainctrlsph=0
2:mcslr5gmpo=0
0:tempthresh=125
0:tempcorrx=0x3f
2:rxgains5ghtrisoa2=5
devpath2=pcie/2/1
1:tempsense_slope=0xff
2:rxgains5ghtrisoa0=5
devpath0=pcie/1/3
2:rxgains5ghtrisoa1=5
devpath1=pcie/1/4
0:aga1=0x0
0:aga2=0x0
0:aga0=0x0
0:tempsense_option=0x3
0:femctrl=3
1:boardflags2=0x00100002
1:boardflags3=0x40000005
2:rxgains5gmtrelnabypa1=1
2:rxgains5gmtrelnabypa2=1
2:rxgains5gmtrelnabypa0=1
2:tssiposslope5g=1
1:sromrev=11
1:tempthresh=120
0:antswitch=0
0:txchain=7
0:boardflags=0x30040000
0:temps_hysteresis=5
0:tempsense_slope=0xff
1:tempcorrx=0x3f
1:dot11agduphrpo=0
1:agbg0=0x0
1:agbg1=0x0
1:agbg2=0x0
2:aa5g=7
0:pdoffset80ma1=0
0:rawtempsense=0x1ff
0:pdoffset80ma2=0
1:devid=0x43bb
0:pdoffset80ma0=0
0:rxchain=7
1:dot11agduplrpo=0
2:tempthresh=120
1:antswitch=0
1:boardflags=0x20001000
EOF

[ "$CHANGED" -eq 0 ] && exit 0

nvram commit

if lsmod | grep -q '^brcmfmac'; then
	rmmod brcmfmac || true
fi
modprobe brcmfmac || true

[ -f /etc/config/wireless ] || wifi config || true

exit 0


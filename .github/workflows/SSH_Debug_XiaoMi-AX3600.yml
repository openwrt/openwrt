name: Build with tmate SSH Debug for XiaoMi-AX3600

on:
  workflow_dispatch:
    inputs:
      manual_config:
        description: "Manually generate XiaoMi-AX3600 config via SSH (y/n)"
        default: "y"
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3 rsync unzip zlib1g-dev file wget
        if apt-cache show python3-distutils 2>/dev/null | grep -q '^Version:'; then
          sudo apt-get install -y python3-distutils
        fi

    # 手动 SSH 配置
    - name: SSH 远程调试（tmate）
      if: ${{ github.event.inputs.manual_config == 'y' }}
      uses: mxschmitt/action-tmate@v3

    # 自动生成 config
    - name: Generate default AX3600 config
      if: ${{ github.event.inputs.manual_config != 'y' }}
      run: |
        echo -e "CONFIG_TARGET_ipq807x=y\nCONFIG_TARGET_ipq807x_generic=y\nCONFIG_TARGET_ipq807x_generic_DEVICE_xiaomi_ax3600=y" > .config
        make defconfig

    - name: Upload config file
      uses: actions/upload-artifact@v4
      with:
        name: ax3600-config
        path: .config

    - name: Continue compilation
      run: |
        if [ ! -f .config ]; then
          echo "No .config file found, please generate config first!"
          exit 1
        fi
        make download -j$(nproc)
        make -j$(nproc) V=s

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: ax3600-firmware
        path: bin/targets/ipq807x/generic/

# 在您的仓库创建：.github/workflows/sync-all-branches.yml
name: Sync All Branches from Upstream

on:
  schedule:
    # 每天凌晨2点同步（UTC时间）
    - cron: '0 2 * * *'
  workflow_dispatch:  # 允许手动触发
  push:  # 当上游有推送时也触发同步
    branches:
      - '**'

jobs:
  sync-all-branches:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检查代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 配置Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
      - name: 添加上游远程仓库
        run: |
          git remote add upstream https://github.com/openwrt/openwrt.git
          git fetch upstream
          
      - name: 获取并同步所有分支
        run: |
          # 获取上游所有分支
          git fetch upstream
          
          # 获取所有上游分支名
          UPSTREAM_BRANCHES=$(git branch -r | grep 'upstream/' | sed 's/upstream\///' | grep -v HEAD)
          
          echo "需要同步的分支:"
          echo "$UPSTREAM_BRANCHES"
          
          # 遍历并同步每个分支
          for BRANCH in $UPSTREAM_BRANCHES; do
            echo "正在同步分支: $BRANCH"
            
            # 检查本地是否存在该分支
            if git show-ref --verify --quiet refs/heads/$BRANCH; then
              # 本地分支存在，合并更新
              git checkout $BRANCH
              git merge --no-edit upstream/$BRANCH || echo "合并可能有冲突，需要手动处理"
            else
              # 本地分支不存在，创建新分支
              git checkout -b $BRANCH upstream/$BRANCH
            fi
            
            # 推送更新到您的仓库
            git push origin $BRANCH
            echo "分支 $BRANCH 同步完成"
          done
          
          # 返回主分支
          git checkout master
          
      - name: 清理
        run: |
          git remote remove upstream

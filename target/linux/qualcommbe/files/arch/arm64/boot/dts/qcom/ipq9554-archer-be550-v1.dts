// SPDX-License-Identifier: (GPL-2.0+)
/dts-v1/;

#include "ipq9574.dtsi"

#include <dt-bindings/clock/qcom,qca8k-nsscc.h>
#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/input/input.h>
#include <dt-bindings/net/qcom,qca808x.h>
#include <dt-bindings/reset/qcom,qca8k-nsscc.h>

/ {
	model = "TP-Link Archer BE550 v1";
	compatible = "tplink,archer-be550-v1", "qcom,ipq9574";

	aliases {
		serial0 = &blsp1_uart2;
	};

	chosen {
		stdout-path = "serial0:115200n8";
	};

	keys {
		compatible = "gpio-keys";
		pinctrl-0 = <&button_pins>;
		pinctrl-names = "default";

		wps {
			label = "wps";
			/* FIXME: when pressed, the GPIO level remains low. Is
			 * there another GPIO involved in the transaction? */
			gpios = <&tlmm 19 GPIO_ACTIVE_LOW>;
			linux,code = <KEY_WPS_BUTTON>;
		};

		wifi {
			label = "wifi";
			gpios = <&tlmm 43 GPIO_ACTIVE_LOW>;
			linux,code = <KEY_WLAN>;
		};

		reset {
			label = "reset";
			gpios = <&tlmm 44 GPIO_ACTIVE_LOW>;
			linux,code = <KEY_RESTART>;
		};

		led-toggle {
			label = "led-toggle";
			gpios = <&tlmm 64 GPIO_ACTIVE_LOW>;
			linux,code = <KEY_LIGHTS_TOGGLE>;
		};
	};

	fixed_uniphy_rx312p5m: fixed-uniphy-rx312p5m {
		compatible = "fixed-clock";
		clock-frequency = <312500000>;
		#clock-cells = <0>;
	};

	fixed_uniphy_tx312p5m: fixed-uniphy-tx312p5m {
		compatible = "fixed-clock";
		clock-frequency = <312500000>;
		#clock-cells = <0>;
	};
};

&mdio {
	pinctrl-0 = <&mdio_pins>, <&phy_reset_pins>;
	pinctrl-names = "default";
	status = "okay";

	qca8k_nsscc: clock-controller@18 {
		compatible = "qcom,qca8084-nsscc";
		reg = <0x18>;
		/* TODO: Is this the PHY reset or clock controller reset? */
		reset-gpios = <&tlmm 60 GPIO_ACTIVE_LOW>;

		clocks = <&cmn_pll ETH0_50MHZ_CLK>,
			 <0>,
			 <0>,
			 <0>,
			 <0>,
			 <&fixed_uniphy_rx312p5m>,
			 <&fixed_uniphy_tx312p5m>;
		#clock-cells = <1>;
		#reset-cells = <1>;
		#power-domain-cells = <1>;
	};

	ethernet-phy-package@0 {
		#address-cells = <1>;
		#size-cells = <0>;
		compatible = "qcom,qca8084-package";
		reg = <0>;
		clocks = <&qca8k_nsscc NSS_CC_APB_BRIDGE_CLK>,
			 <&qca8k_nsscc NSS_CC_AHB_CLK>,
			 <&qca8k_nsscc NSS_CC_SEC_CTRL_AHB_CLK>,
			 <&qca8k_nsscc NSS_CC_TLMM_CLK>,
			 <&qca8k_nsscc NSS_CC_TLMM_AHB_CLK>,
			 <&qca8k_nsscc NSS_CC_CNOC_AHB_CLK>,
			 <&qca8k_nsscc NSS_CC_MDIO_AHB_CLK>;
		clock-names = "apb_bridge",
			      "ahb",
			      "sec_ctrl_ahb",
			      "tlmm",
			      "tlmm_ahb",
			      "cnoc_ahb",
			      "mdio_ahb";
		resets = <&qca8k_nsscc NSS_CC_GEPHY_FULL_ARES>;

		/* TODO: UPdate driver to use string:
		 * qcom,package-mode = "10g-qxgmii";
		 */
		qcom,package-mode = <QCA808X_PCS1_10G_QXGMII_PCS0_UNUNSED>;
		qcom,phy-addr-fixup = <1 2 3 4 5 6 7>;

		qca8084_0: ethernet-phy@0 {
			compatible = "ethernet-phy-id004d.d180";
			reg = <1>;
			clocks = <&qca8k_nsscc NSS_CC_GEPHY0_SYS_CLK>;
			resets = <&qca8k_nsscc NSS_CC_GEPHY0_SYS_ARES>;
			qcom,xpcs-channel = <0>;
		};
		qca8084_1: ethernet-phy@1 {
			compatible = "ethernet-phy-id004d.d180";
			reg = <2>;
			clocks = <&qca8k_nsscc NSS_CC_GEPHY1_SYS_CLK>;
			resets = <&qca8k_nsscc NSS_CC_GEPHY1_SYS_ARES>;
			qcom,xpcs-channel = <1>;
		};
		qca8084_2: ethernet-phy@2 {
			compatible = "ethernet-phy-id004d.d180";
			reg = <3>;
			clocks = <&qca8k_nsscc NSS_CC_GEPHY2_SYS_CLK>;
			resets = <&qca8k_nsscc NSS_CC_GEPHY2_SYS_ARES>;
			qcom,xpcs-channel = <2>;
		};
		qca8084_3: ethernet-phy@3 {
			compatible = "ethernet-phy-id004d.d180";
			reg = <4>;
			clocks = <&qca8k_nsscc NSS_CC_GEPHY3_SYS_CLK>;
			resets = <&qca8k_nsscc NSS_CC_GEPHY3_SYS_ARES>;
			qcom,xpcs-channel = <3>;
		};

		pcs-phy@6 {
			compatible = "qcom,qca8k-pcs-phy";
			reg = <6>;
			clocks = <&qca8k_nsscc NSS_CC_SRDS1_SYS_CLK>,
				 <&fixed_uniphy_tx312p5m>,
				 <&fixed_uniphy_rx312p5m>;
			clock-names = "pcs",
				      "pcs_rx_root",
				      "pcs_tx_root";
			resets = <&qca8k_nsscc NSS_CC_SRDS1_SYS_ARES>;
		};

		xpcs-phy@7 {
			compatible = "qcom,qca8k-xpcs-phy";
			reg = <7>;
			#address-cells = <1>;
			#size-cells = <0>;
			resets = <&qca8k_nsscc NSS_CC_XPCS_ARES>;

			channel@0 {
				reg = <0>;
				clocks = <&qca8k_nsscc NSS_CC_MAC1_SRDS1_CH0_XGMII_TX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC1_SRDS1_CH0_XGMII_RX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC1_SRDS1_CH0_TX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC1_SRDS1_CH0_RX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC1_GEPHY0_RX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC1_GEPHY0_TX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC1_RX_CLK_SRC>,
					 <&qca8k_nsscc NSS_CC_MAC1_TX_CLK_SRC>;
				clock-names = "xgmii_rx",
					      "xgmii_tx",
					      "xpcs_rx",
					      "xpcs_tx",
					      "port_rx",
					      "port_tx",
					      "rx_src",
					      "tx_src";
				resets = <&qca8k_nsscc NSS_CC_MAC1_SRDS1_CH0_XGMII_TX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC1_SRDS1_CH0_XGMII_RX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC1_SRDS1_CH0_TX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC1_SRDS1_CH0_RX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC1_GEPHY0_RX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC1_GEPHY0_TX_ARES>;
				reset-names = "xgmii_rx",
					      "xgmii_tx",
					      "xpcs_rx",
					      "xpcs_tx",
					      "port_rx",
					      "port_tx";
			};

			channel@1 {
				reg = <1>;
				clocks = <&qca8k_nsscc NSS_CC_MAC2_SRDS1_CH1_XGMII_TX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC2_SRDS1_CH1_XGMII_RX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC2_SRDS1_CH1_TX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC2_SRDS1_CH1_RX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC2_GEPHY1_RX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC2_GEPHY1_TX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC2_RX_CLK_SRC>,
					 <&qca8k_nsscc NSS_CC_MAC2_TX_CLK_SRC>;
				clock-names = "xgmii_rx",
					      "xgmii_tx",
					      "xpcs_rx",
					      "xpcs_tx",
					      "port_rx",
					      "port_tx",
					      "rx_src",
					      "tx_src";
				resets = <&qca8k_nsscc NSS_CC_MAC2_SRDS1_CH1_XGMII_TX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC2_SRDS1_CH1_XGMII_RX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC2_SRDS1_CH1_TX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC2_SRDS1_CH1_RX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC2_GEPHY1_RX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC2_GEPHY1_TX_ARES>;
				reset-names = "xgmii_rx",
					      "xgmii_tx",
					      "xpcs_rx",
					      "xpcs_tx",
					      "port_rx",
					      "port_tx";
			};

			channel@2 {
				reg = <2>;
				clocks = <&qca8k_nsscc NSS_CC_MAC3_SRDS1_CH2_XGMII_TX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC3_SRDS1_CH2_XGMII_RX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC3_SRDS1_CH2_TX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC3_SRDS1_CH2_RX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC3_GEPHY2_RX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC3_GEPHY2_TX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC3_RX_CLK_SRC>,
					 <&qca8k_nsscc NSS_CC_MAC3_TX_CLK_SRC>;
				clock-names = "xgmii_rx",
					      "xgmii_tx",
					      "xpcs_rx",
					      "xpcs_tx",
					      "port_rx",
					      "port_tx",
					      "rx_src",
					      "tx_src";
				resets = <&qca8k_nsscc NSS_CC_MAC3_SRDS1_CH2_XGMII_TX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC3_SRDS1_CH2_XGMII_RX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC3_SRDS1_CH2_TX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC3_SRDS1_CH2_RX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC3_GEPHY2_RX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC3_GEPHY2_TX_ARES>;
				reset-names = "xgmii_rx",
					      "xgmii_tx",
					      "xpcs_rx",
					      "xpcs_tx",
					      "port_rx",
					      "port_tx";
			};

			channel@3 {
				reg = <3>;
				clocks = <&qca8k_nsscc NSS_CC_MAC4_SRDS1_CH3_XGMII_TX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC4_SRDS1_CH3_XGMII_RX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC4_SRDS1_CH3_TX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC4_SRDS1_CH3_RX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC4_GEPHY3_RX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC4_GEPHY3_TX_CLK>,
					 <&qca8k_nsscc NSS_CC_MAC4_RX_CLK_SRC>,
					 <&qca8k_nsscc NSS_CC_MAC4_TX_CLK_SRC>;
				clock-names = "xgmii_rx",
					      "xgmii_tx",
					      "xpcs_rx",
					      "xpcs_tx",
					      "port_rx",
					      "port_tx",
					      "rx_src",
					      "tx_src";
				resets = <&qca8k_nsscc NSS_CC_MAC4_SRDS1_CH3_XGMII_TX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC4_SRDS1_CH3_XGMII_RX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC4_SRDS1_CH3_TX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC4_SRDS1_CH3_RX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC4_GEPHY3_RX_ARES>,
					 <&qca8k_nsscc NSS_CC_MAC4_GEPHY3_TX_ARES>;
				reset-names = "xgmii_rx",
					      "xgmii_tx",
					      "xpcs_rx",
					      "xpcs_tx",
					      "port_rx",
					      "port_tx";
			};
		};
	};

	qca8081_12: ethernet-phy@12 {
		reset-gpios = <&tlmm 36 GPIO_ACTIVE_LOW>;
		reset-deassert-us = <1000>;
		reg = <12>;
	};
};

&tlmm {
	button_pins: button-pins {
		pins = "gpio19", "gpio43", "gpio44", "gpio64";
		function = "gpio";
		input;
		bias-pull-up;
	};

	i2c3_pins: i2c3-pins {
		pins = "gpio15", "gpio16";
		function = "blsp3_i2c";
		drive-strength = <8>;
		bias-disable;
	};

	pcie2_pins: pcie2-pins {
		clkreq-n-pin {
			pins = "gpio28";
			function = "pcie2_clk";
			drive-strength = <6>;
			bias-pull-up;
		};

		perst-n-pin {
			pins = "gpio29";
			function = "gpio";
			drive-strength = <8>;
			bias-disable;
			output-low;
		};
	};

	qspi_nand_pins: qspi_nand_pins {
		qspi_clock {
			pins = "gpio5";
			function = "qspi_clk";
			drive-strength = <8>;
			bias-disable;
		};

		qspi_cs {
			pins = "gpio4";
			function = "qspi_cs";
			drive-strength = <8>;
			bias-disable;
		};

		qspi_data {
			pins = "gpio0", "gpio1", "gpio2", "gpio3";
			function = "qspi_data";
			drive-strength = <8>;
			bias-disable;
		};
	};

	phy_reset_pins: phy-reset-pins {
		pins = "gpio36", "gpio60";
		function = "gpio";
		drive-strength = <2>;
		bias-disable;
	};
};

&qpic_bam {
	status = "okay";
};

&qpic_nand {
	pinctrl-0 = <&qspi_nand_pins>;
	pinctrl-names = "default";
	status = "okay";

	nand@0 {
		compatible = "spi-nand";
		reg = <0>;
		#address-cells = <1>;
		#size-cells = <1>;
		nand-ecc-engine = <&qpic_nand>;
		nand-ecc-strength = <4>;
		nand-ecc-step-size = <512>;

		partitions {
			compatible = "qcom,smem-part";
		};
	};
};

&rpm_requests {
	regulators {
		compatible = "qcom,rpm-mp5496-regulators";

		ipq9574_s1: s1 {
			regulator-min-microvolt = <725000>;
			regulator-max-microvolt = <1075000>;
		};
	};
};

&pcs1 {
	/* No uniphy1 for you! (ipq9554 doesn't have uniphy1) */
	status = "disabled";
};

&qcom_ppe {
	status = "okay";

	ethernet-ports {
		#address-cells = <1>;
		#size-cells = <0>;

		port@1 {
			reg = <1>;
			phy-mode = "10g-qxgmii";
			label = "lan1";
			phy-handle = <&qca8084_0>;
			pcs-handle = <&pcs0_ch0>;
			clocks = <&nsscc NSS_CC_PORT1_MAC_CLK>,
				 <&nsscc NSS_CC_PORT1_RX_CLK>,
				 <&nsscc NSS_CC_PORT1_TX_CLK>;
			clock-names = "mac",
				      "rx",
				      "tx";
			resets = <&nsscc PORT1_MAC_ARES>,
				 <&nsscc PORT1_RX_ARES>,
				 <&nsscc PORT1_TX_ARES>;
			reset-names = "mac",
				      "rx",
				      "tx";
		};

		port@2 {
			reg = <2>;
			phy-mode = "10g-qxgmii";
			label = "lan2";
			phy-handle = <&qca8084_1>;
			pcs-handle = <&pcs0_ch1>;
			clocks = <&nsscc NSS_CC_PORT2_MAC_CLK>,
				 <&nsscc NSS_CC_PORT2_RX_CLK>,
				 <&nsscc NSS_CC_PORT2_TX_CLK>;
			clock-names = "mac",
				      "rx",
				      "tx";
			resets = <&nsscc PORT2_MAC_ARES>,
				 <&nsscc PORT2_RX_ARES>,
				 <&nsscc PORT2_TX_ARES>;
			reset-names = "mac",
				      "rx",
				      "tx";
		};

		port@3 {
			reg = <3>;
			phy-mode = "10g-qxgmii";
			label = "lan3";
			phy-handle = <&qca8084_2>;
			pcs-handle = <&pcs0_ch2>;
			clocks = <&nsscc NSS_CC_PORT3_MAC_CLK>,
				 <&nsscc NSS_CC_PORT3_RX_CLK>,
				 <&nsscc NSS_CC_PORT3_TX_CLK>;
			clock-names = "mac",
				      "rx",
				      "tx";
			resets = <&nsscc PORT3_MAC_ARES>,
				 <&nsscc PORT3_RX_ARES>,
				 <&nsscc PORT3_TX_ARES>;
			reset-names = "mac",
				      "rx",
				      "tx";
		};

		port@4 {
			reg = <4>;
			phy-mode = "10g-qxgmii";
			label = "lan4";
			phy-handle = <&qca8084_3>;
			pcs-handle = <&pcs0_ch3>;
			clocks = <&nsscc NSS_CC_PORT4_MAC_CLK>,
				 <&nsscc NSS_CC_PORT4_RX_CLK>,
				 <&nsscc NSS_CC_PORT4_TX_CLK>;
			clock-names = "mac",
				      "rx",
				      "tx";
			resets = <&nsscc PORT4_MAC_ARES>,
				 <&nsscc PORT4_RX_ARES>,
				 <&nsscc PORT4_TX_ARES>;
			reset-names = "mac",
				      "rx",
				      "tx";
		};

		port@6 {
			reg = <6>;
			phy-mode = "usxgmii";
			managed = "in-band-status";
			label = "wan";
			phy-handle = <&qca8081_12>;
			pcs-handle = <&pcs2_ch0>;
			clocks = <&nsscc NSS_CC_PORT6_MAC_CLK>,
				 <&nsscc NSS_CC_PORT6_RX_CLK>,
				 <&nsscc NSS_CC_PORT6_TX_CLK>;
			clock-names = "mac",
				      "rx",
				      "tx";
			resets = <&nsscc PORT6_MAC_ARES>,
				 <&nsscc PORT6_RX_ARES>,
				 <&nsscc PORT6_TX_ARES>;
			reset-names = "mac",
				      "rx",
				      "tx";
		};
	};
};

&pcie2_phy {
	status = "okay";
};

&pcie2 {
	pinctrl-0 = <&pcie2_pins>;
	pinctrl-names = "default";
	perst-gpios = <&tlmm 29 GPIO_ACTIVE_LOW>;
	status = "okay";
};

&blsp1_i2c3 {
	pinctrl-0 = <&i2c3_pins>;
	pinctrl-names = "default";
	status = "okay";
};

&blsp1_uart2 {
	pinctrl-0 = <&uart2_pins>;
	pinctrl-names = "default";
	status = "okay";
};

&usb_0_qusbphy {
	status = "okay";
};

&usb_0_qmpphy{
	status = "okay";
};

&usb3 {
	status = "okay";
};

&sleep_clk {
	clock-frequency = <32000>;
};

/*
 * The clock tree follows:
 *     xo_clk ->  ref_48mhz_clk -> xo_board_clk
 *
 * I have no ides what the original oscillator frequency is, but however we
 * xo_clk and the multipliers, ref_48mhz_clk shoudl be 48 MHz.
 */
&xo_clk {
	// clock-frequency = <48000000>;
	clock-frequency = <24000000>;
};

&ref_48mhz_clk {
	clock-div = <1>;
	clock-mult = <2>;
};

&xo_board_clk {
	clock-div = <2>;
	clock-mult = <1>;
};
